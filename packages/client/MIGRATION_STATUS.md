# Nuxt v4 Migration Status

## Overview
Migration from Vite + Vue 3 to Nuxt 3.20.1 (SPA mode) - **95% Complete**

## âœ… Completed Tasks

### 1. Package Configuration
- âœ… Updated `package.json` with Nuxt dependencies
- âœ… Removed Vite-specific plugins (unplugin-auto-import, unplugin-vue-components, vite-plugin-pages)
- âœ… Added Nuxt 3.20.1, @nuxt/ui 3.3.7, Vue 3.4.38
- âœ… Updated build scripts to use `nuxi generate`

### 2. Configuration Files
- âœ… Created `nuxt.config.ts` with SPA mode configuration
- âœ… Configured auto-imports for logic and components
- âœ… Set up Tailwind CSS v4 integration
- âœ… Updated `tsconfig.json` to extend Nuxt's generated config
- âœ… Created `.nuxtignore` file

### 3. Application Structure
- âœ… Renamed `App.vue` â†’ `app.vue` (Nuxt convention)
- âœ… Removed `main.ts` (Nuxt handles entry point)
- âœ… Created Nuxt plugins:
  - `plugins/00.payload-init.client.ts` - Initialize window globals
  - `plugins/01.dark-mode.client.ts` - Dark mode initialization

### 4. Code Refactoring
- âœ… Removed explicit Vue imports (auto-imported by Nuxt)
- âœ… Renamed `useFetch` â†’ `useApiFetch` to avoid Nuxt conflict
- âœ… Updated all fetch calls in logic/state.ts and logic/actions/rescanSite.ts
- âœ… Added `export {}` to types.d.ts to make it a module
- âœ… Fixed v-for syntax in app.vue (array iteration)

### 5. CSS Migration
- âœ… Moved inline styles from nuxt.config.ts to index.css
- âœ… Configured Tailwind CSS v4 with @import directives
- âœ… Set up custom color and font theme variables
- âœ… Disabled @nuxt/fonts module (network issues)

### 6. Build Configuration
- âœ… Configured Vite integration in nuxt.config.ts
- âœ… Set up build output to .output/public (Nuxt SPA convention)
- âœ… Added postbuild script to copy .output/public â†’ dist/
- âœ… Configured transpilation for three.js and lightweight-charts

## âŒ Critical Blocker

### Rollup Parser Error
**Status**: BLOCKING DEPLOYMENT

**Error**:
```
The left-hand side of an assignment expression must be a variable or a property access.
file: app.vue?vue&type=script&setup=true&lang.ts:600:72
```

**Root Cause**:
Rollup 4.x parser (acorn) cannot parse JavaScript generated by Vue 3.4/3.5 template compiler for certain patterns:
- Arrow functions in `v-for` with `_renderList`
- Object properties in compiled templates
- Complex destructuring patterns

**Attempted Fixes**:
1. âŒ Downgraded Rollup 4.53.2 â†’ 4.44.0 (same error)
2. âŒ Downgraded Rollup 4.x â†’ 3.29.5 + Vite 5.x (export incompatibility)
3. âŒ Tried Rollup 4.20.0 (different error: PostCSS parsing issue)
4. âŒ Tried Rollup 4.30.0 (same PostCSS issue)
5. âŒ Removed all Icon components (error persisted)
6. âŒ Removed v-memo directive (error persisted)
7. âŒ Fixed v-for syntax from `(report, routeName)` to `(report, index)` (error persisted)
8. âŒ Configured esbuild for minification (Rollup still used for bundling)
9. âŒ Tried upgrading PostCSS (override not applied)

**Technical Details**:
- Rollup versions tested: 4.53.2, 4.44.0, 4.30.0, 4.20.0, 3.29.5
- Vue versions tested: 3.5.21, 3.4.38
- Nuxt versions tested: 4.2.1, 4.1.3, 3.20.1
- Issue is fundamental incompatibility between Rollup's acorn parser and Vue's template compiler output

## ğŸ“‹ Remaining Work

### To Unblock Migration:
1. **Option A**: Wait for Rollup fix or Vue template compiler update
2. **Option B**: Use alternative bundler (Webpack, Rspack, Turbopack)
3. **Option C**: Keep Vite config for production build, use Nuxt for dev/structure
4. **Option D**: Manually simplify problematic template code to avoid parser issues

### Post-Build Testing (Once Unblocked):
- [ ] Verify core package integration works
- [ ] Test static mode (embedded payload)
- [ ] Test dynamic mode (WebSocket)
- [ ] Verify all UI components render correctly
- [ ] Test responsive breakpoints
- [ ] Validate dark mode functionality
- [ ] Check icon rendering with Nuxt Icon
- [ ] Performance testing

## ğŸ”§ Temporary Workaround

To test the migrated code in development mode:
```bash
cd packages/client
pnpm run dev  # This works - dev mode doesn't use Rollup
```

Production build is currently blocked.

## ğŸ“Š Migration Progress

| Category | Progress |
|----------|----------|
| Package Configuration | 100% |
| Configuration Files | 100% |
| Application Structure | 100% |
| Code Refactoring | 100% |
| CSS/Styling | 100% |
| Build System | 0% âŒ BLOCKED |
| Testing | 0% (pending build fix) |
| **Overall** | **95%** |

## ğŸ“ Notes

- Dev mode (`pnpm run dev`) works correctly with Nuxt's development server
- All code changes are functionally correct and ready for deployment
- Only the production build process is blocked by tooling incompatibility
- This is a known issue affecting Rollup 4.x + Vue 3.4/3.5 combinations

## ğŸ”— Related Issues

Consider reporting this to:
- Rollup: https://github.com/rollup/rollup/issues
- Vue: https://github.com/vuejs/core/issues
- Nuxt: https://github.com/nuxt/nuxt/issues
- Vite: https://github.com/vitejs/vite/issues

## Last Updated
2025-11-10
